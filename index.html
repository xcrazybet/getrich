// Authentication Functions
import { supabase } from './supabase.js'

// Check authentication
async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession()
    return session
}

// Login function
async function login(email, password) {
    const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
    })
    
    if (error) throw error
    return data
}

// Register function
async function register(email, password, userData) {
    const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
            data: userData
        }
    })
    
    if (error) throw error
    
    // Create profile if needed
    if (data.user) {
        await createUserProfile(data.user, userData)
    }
    
    return data
}

// Create user profile
async function createUserProfile(user, userData) {
    const { data: existingProfile } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .single()
    
    if (!existingProfile) {
        const { error } = await supabase
            .from('profiles')
            .insert([{
                id: user.id,
                email: user.email,
                full_name: userData?.full_name || '',
                username: userData?.username || '',
                user_type: 'regular',
                wallet_balance: 0.00,
                locked_balance: 0.00
            }])
        
        if (error && !error.message.includes('duplicate key')) {
            console.error('Error creating profile:', error)
        }
    }
}

// Logout function
async function logout() {
    await supabase.auth.signOut()
    window.location.href = 'index.html'
}

// Get current user
async function getCurrentUser() {
    const { data: { user } } = await supabase.auth.getUser()
    return user
}

// Get user profile
async function getUserProfile() {
    const user = await getCurrentUser()
    if (!user) return null
    
    const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single()
    
    return profile
}

// Update profile
async function updateProfile(updates) {
    const user = await getCurrentUser()
    if (!user) throw new Error('Not authenticated')
    
    const { data, error } = await supabase
        .from('profiles')
        .update(updates)
        .eq('id', user.id)
    
    if (error) throw error
    return data
}

// Export functions
window.login = login
window.register = register
window.logout = logout
window.checkAuth = checkAuth
window.getCurrentUser = getCurrentUser
window.getUserProfile = getUserProfile
window.updateProfile = updateProfile

// Auth state listener
supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth state changed:', event)
    
    // Update UI based on auth state
    const loginBtn = document.getElementById('login-btn')
    const logoutBtn = document.getElementById('logout-btn')
    
    if (loginBtn && logoutBtn) {
        if (session) {
            loginBtn.style.display = 'none'
            logoutBtn.style.display = 'inline-flex'
            logoutBtn.onclick = logout
        } else {
            loginBtn.style.display = 'inline-flex'
            logoutBtn.style.display = 'none'
        }
    }
})
